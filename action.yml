name: Arnica SBOM Upload
description: Upload an SBOM to Arnica and wait for the scan to complete
branding:
  icon: upload-cloud
  color: blue
inputs:
  repository-url:
    description: Repository URL associated with the SBOM
    required: true
  branch:
    description: Branch name associated with the SBOM
    required: false
    default: main
  scan-path:
    description: Repository path to associate with the scan
    required: true
  api-base-url:
    description: Arnica API base URL (e.g., https://api.app.arnica.io)
    required: true
    default: https://api.app.arnica.io
  curl-flags:
    description: Additional flags to pass to curl (optional)
    required: false
    default: ""
  scan-timeout-seconds:
    description: Maximum time to wait for scan completion in seconds
    required: false
    default: "900"
  api-token:
    description: Arnica API token (prefer passing via secrets)
    required: false
  on-findings:
    description: Controls behavior when policy violations or findings are detected. One of fail|alert|pass
    required: false
    default: fail
  cdxgen-version:
    description: Version of @cyclonedx/cdxgen to install
    required: false
    default: "11.5.0"
outputs:
  scan-id:
    description: Arnica scan identifier
    value: ${{ steps.arnica.outputs.scan_id }}
  status:
    description: Final scan status (Success, Failure, Error, Skipped, Timeout)
    value: ${{ steps.arnica.outputs.status }}
runs:
  using: composite
  steps:
    - name: Install node
      uses: actions/setup-node@a0853c24544627f65ddf259abe73b1d18a591444 # v5

    - name: Install cdxgen
      shell: bash
      run: npm install -g @cyclonedx/cdxgen@${{ inputs.cdxgen-version }}

    - name: Create SBOM
      shell: bash
      run: |
        # Creating SBOM in the scan-path
        cd ${{ inputs.scan-path }}
        cdxgen .
        # debug:
        cat bom.json |jq  '.metadata.tools.components[0]'
        # End debug

    - name: Ensure jq is installed
      shell: bash
      run: |
        # Ensure jq is installed
        set -euo pipefail
        if ! command -v jq >/dev/null 2>&1; then
          sudo apt-get update -y
          sudo apt-get install -y jq
        fi

    - name: Upload SBOM to Arnica and wait for scan
      id: arnica
      shell: bash
      env:
        REPO: ${{ inputs.repository-url }}
        BRANCH: ${{ inputs.branch }}
        SBOM: ${{ inputs.scan-path }}/bom.json
        SCAN_PATH: ${{ inputs.scan-path }}
        API: ${{ inputs.api-base-url }}
        CURL_FLAGS: ${{ inputs.curl-flags }}
        SCAN_TIMEOUT_SECONDS: ${{ inputs.scan-timeout-seconds }}
        API_TOKEN_INPUT: ${{ inputs.api-token }}
        ON_FINDINGS: ${{ inputs.on-findings }}
      run: |
        # Upload SBOM to Arnica and wait for scan
        set -euo pipefail

        if [ -z "${REPO:-}" ] || [ -z "${BRANCH:-}" ] || [ -z "${SBOM:-}" ] || [ -z "${SCAN_PATH:-}" ]; then
          echo "Missing required inputs."
          exit 1
        fi

        if [ -z "${API:-}" ]; then
          echo "API endpoint is not defined. Provide input 'api-base-url'."
          exit 1
        fi

        # Expect SBOM file at the provided path (typically ./bom.json)
        if [ ! -f "$SBOM" ]; then
          echo "SBOM file not found: $SBOM"
          exit 1
        fi

        if [ -n "${API_TOKEN_INPUT:-}" ]; then
          TOKEN="$API_TOKEN_INPUT"
        elif [ -n "${ARNICA_API_TOKEN:-}" ]; then
          TOKEN="$ARNICA_API_TOKEN"
        else
          echo "Error: API token is missing. Pass env ARNICA_API_TOKEN from a secret."
          exit 1
        fi

        SCAN_TIMEOUT="${SCAN_TIMEOUT_SECONDS:-900}"

        echo "Starting SBOM scan..."
        # Normalize API path to start with '/'
        case "$SCAN_PATH" in
          /*) API_PATH="$SCAN_PATH" ;;
          "") API_PATH="/" ;;
          *) API_PATH="/$SCAN_PATH" ;;
        esac

        REQUEST_BODY=$(jq -n \
          --arg repo "$REPO" \
          --arg branch "$BRANCH" \
          --arg path "$SCAN_PATH" \
          '{repositoryUrl: $repo, branch: $branch, path: $path}')

        RESULT=$(curl ${CURL_FLAGS:-} -Ss -X 'POST' \
          "${API}/v1/sbom/scan/upload" \
          -H 'accept: application/json' \
          -H "Authorization: Bearer ${TOKEN}" \
          -H 'Content-Type: application/json' \
          -d "$REQUEST_BODY")

        STATUS=$(echo "$RESULT" | jq -r .statusCode)
        if [ "$STATUS" != "null" ] && [ "$STATUS" -ne 200 ]; then
          MESSAGE=$(echo "$RESULT" | jq -r .message)
          if [ -n "${GITHUB_STEP_SUMMARY:-}" ]; then
            {
              echo "## Arnica SBOM Scan"
              echo ""
              echo "- Repository: $REPO"
              echo "- Branch: $BRANCH"
              echo "- Path: $SCAN_PATH"
              echo "- Status: StartFailed ($STATUS)"
              if [ -n "$MESSAGE" ] && [ "$MESSAGE" != "null" ]; then
                echo ""
                echo "### Error"
                echo ""
                echo "$MESSAGE"
              fi
            } >> "$GITHUB_STEP_SUMMARY"
          fi
          echo "status=Error" >> "$GITHUB_OUTPUT"
          echo "Start SBOM scan failed with status code $STATUS, message: $MESSAGE"
          exit 1
        fi

        SCANID=$(echo "$RESULT" | jq -r .scanId)
        URL=$(echo "$RESULT" | jq -r .uploadUrl)

        if [ -z "$SCANID" ] || [ -z "$URL" ] || [ "$SCANID" = "null" ] || [ "$URL" = "null" ]; then
          echo "Failed to obtain scanId or uploadUrl from API response: $RESULT"
          exit 1
        fi

        echo "scanId=$SCANID"
        echo "scan_id=$SCANID" >> "$GITHUB_OUTPUT"
        echo "Uploading SBOM..."
        echo "DEBUG: SBOM: SBOM file: $SBOM"
        echo "DEBUG: API_PATH: ls -la $API_PATH"
        echo "DEBUG: SCAN_PATH: ls -la $SCAN_PATH"
        echo "DEBUG: REQUEST_BODY: $REQUEST_BODY"
        echo "DEBUG: tools $(cat $SBOM |jq  '.metadata.tools.components[0]')"

        curl -H "Content-Type: application/json" ${CURL_FLAGS:-} -Ss -X PUT --data-binary @"$SBOM" "$URL"
        echo "Upload completed."

        START_TIME=$(date +%s)
        echo "Waiting for scan completion (timeout: ${SCAN_TIMEOUT}s)..."

        while true; do
          CURRENT_TIME=$(date +%s)
          ELAPSED_TIME=$((CURRENT_TIME - START_TIME))

          if [ "$ELAPSED_TIME" -ge "$SCAN_TIMEOUT" ]; then
            echo "status=Timeout" >> "$GITHUB_OUTPUT"
            echo "Scan did not complete within the timeout."
            exit 1
          fi

          RESPONSE=$(curl ${CURL_FLAGS:-} -sS -X GET \
            "${API}/v1/sbom/scan/${SCANID}/status" \
            -H "accept: application/json" \
            -H "Authorization: Bearer ${TOKEN}")

          echo "=== FULL API RESPONSE DEBUG ==="
          echo "$RESPONSE" | jq '.' 2>/dev/null || echo "Raw response: $RESPONSE"
          echo "=== END DEBUG ==="

          STATUS=$(echo "$RESPONSE" | jq -r '.status // empty')
          REASON=$(echo "$RESPONSE" | jq -r '.reason // empty')
          ERRORS_JSON=$(echo "$RESPONSE" | jq -c '.errors // []')

          write_summary() {
            if [ -n "${GITHUB_STEP_SUMMARY:-}" ]; then
              {
                echo "## Arnica SBOM Scan"
                echo ""
                echo "- Repository: $REPO"
                echo "- Branch: $BRANCH"
                echo "- Path: $API_PATH"
                echo "- Scan ID: $SCANID"
                echo "- Status: $STATUS"
                if [ -n "$REASON" ] && [ "$REASON" != "null" ]; then
                  echo "- Reason: $REASON"
                fi
                if [ -n "$ERRORS_JSON" ] && [ "$ERRORS_JSON" != "null" ] && [ "$ERRORS_JSON" != "[]" ]; then
                  echo ""
                  echo "### Errors"
                  echo ""
                  echo "$ERRORS_JSON" | jq -r '.[] | "- \(.)"'
                fi
                TOTAL=$(echo "$RESPONSE" | jq -r '.findingsSummary.total // 0')
                if [ "$TOTAL" != "0" ] && [ -n "$TOTAL" ] && [ "$TOTAL" != "null" ]; then
                  CRITICAL=$(echo "$RESPONSE" | jq -r '.findingsSummary.critical // 0')
                  HIGH=$(echo "$RESPONSE" | jq -r '.findingsSummary.high // 0')
                  MEDIUM=$(echo "$RESPONSE" | jq -r '.findingsSummary.medium // 0')
                  LOW=$(echo "$RESPONSE" | jq -r '.findingsSummary.low // 0')
                  INFO=$(echo "$RESPONSE" | jq -r '.findingsSummary.info // 0')
                  echo ""
                  echo "### Findings Summary"
                  echo ""
                  echo "| severity | count |"
                  echo "|---|---|"
                  echo "| critical | $CRITICAL |"
                  echo "| high | $HIGH |"
                  echo "| medium | $MEDIUM |"
                  echo "| low | $LOW |"
                  echo "| info | $INFO |"
                  echo "| total | $TOTAL |"
                  FINDINGS_JSON=$(echo "$RESPONSE" | jq -c '.findingsSummary.findings // []')
                  COUNT=$(echo "$FINDINGS_JSON" | jq 'length')
                  if [ "$COUNT" -gt 0 ]; then
                    echo ""
                    echo "### Findings (showing up to 50)"
                    echo ""
                    echo "| severity | type | title | status | recommendation |"
                    echo "|---|---|---|---|---|"
                    echo "$FINDINGS_JSON" | jq -r '
                      .[] |
                        "| " +
                        (.severity // "") + " | " +
                        (.type // "") + " | " +
                        ((.title // "") | gsub("\\|"; "\\\\|")) + " | " +
                        (.status // "") + " | " +
                        ((.recommendation // "N/A") | gsub("\\|"; "\\\\|")) + " |"
                    '
                  fi
                fi
              } >> "$GITHUB_STEP_SUMMARY"
            fi
          }

          if [ "$STATUS" = "Failure" ]; then
            echo "One or more policy violations found."
            echo "status=Failure" >> "$GITHUB_OUTPUT"

            # Best-effort: fetch findings if not yet populated
            ATTEMPTS=0
            FINDINGS_COUNT=$(echo "$RESPONSE" | jq -r '(.findingsSummary.findings // []) | length')
            while [ "${FINDINGS_COUNT:-0}" -eq 0 ] && [ $ATTEMPTS -lt 5 ]; do
              sleep 2
              RESPONSE=$(curl ${CURL_FLAGS:-} -sS -X GET \
                "${API}/v1/sbom/scan/${SCANID}/status" \
                -H "accept: application/json" \
                -H "Authorization: Bearer ${TOKEN}")
              STATUS=$(echo "$RESPONSE" | jq -r '.status // empty')
              FINDINGS_COUNT=$(echo "$RESPONSE" | jq -r '(.findingsSummary.findings // []) | length')
              ATTEMPTS=$((ATTEMPTS+1))
            done

            # Console summary for quick visibility
            TOTAL=$(echo "$RESPONSE" | jq -r '.findingsSummary.total // 0')
            if [ -n "$TOTAL" ] && [ "$TOTAL" != "null" ] && [ "$TOTAL" -ne 0 ]; then
              CRITICAL=$(echo "$RESPONSE" | jq -r '.findingsSummary.critical // 0')
              HIGH=$(echo "$RESPONSE" | jq -r '.findingsSummary.high // 0')
              MEDIUM=$(echo "$RESPONSE" | jq -r '.findingsSummary.medium // 0')
              LOW=$(echo "$RESPONSE" | jq -r '.findingsSummary.low // 0')
              INFO=$(echo "$RESPONSE" | jq -r '.findingsSummary.info // 0')
              echo "Findings summary: total=$TOTAL critical=$CRITICAL high=$HIGH medium=$MEDIUM low=$LOW info=$INFO"
              CONSOLE_FINDINGS=$(echo "$RESPONSE" | jq -r '(.findingsSummary.findings // []) | length')
              if [ "$CONSOLE_FINDINGS" -gt 0 ]; then
                echo "Top findings:"
                FINDINGS_JSON=$(echo "$RESPONSE" | jq -c '(.findingsSummary.findings // [])[0:10][]' 2>/dev/null)
                if [ -n "$FINDINGS_JSON" ]; then
                  i=0
                  echo "$FINDINGS_JSON" | while IFS= read -r finding; do
                    SEVERITY=$(echo "$finding" | jq -r '.severity // "N/A"')
                    TYPE=$(echo "$finding" | jq -r '.type // "N/A"')
                    TITLE=$(echo "$finding" | jq -r '.title // "N/A"')
                    STATUS=$(echo "$finding" | jq -r '.status // "N/A"')
                    RECOMMENDATION=$(echo "$finding" | jq -r '.recommendation // "N/A"')
                    printf -- "- [%s] %s (%s) status=%s\n  Recommendation: %s\n" "$SEVERITY" "$TITLE" "$TYPE" "$STATUS" "$RECOMMENDATION"
                    i=$((i+1))
                  done
                else
                  echo "Error parsing findings for console output"
                fi
              else
                echo "No detailed findings available yet (findings may still be processing)"
              fi
            fi

            write_summary
            case "${ON_FINDINGS:-fail}" in
              alert|pass) exit 0 ;;
              *) exit 1 ;;
            esac
          fi

          if [ "$STATUS" = "Error" ]; then
            echo "Errors encountered during SBOM scan."
            echo "status=Error" >> "$GITHUB_OUTPUT"
            write_summary
            exit 1
          fi

          if [ "$STATUS" = "Skipped" ]; then
            echo "Scan skipped."
            echo "status=Skipped" >> "$GITHUB_OUTPUT"
            write_summary
            exit 0
          fi

          if [ "$STATUS" = "Success" ]; then
            echo "Scan completed successfully."
            echo "status=Success" >> "$GITHUB_OUTPUT"
            write_summary
            exit 0
          fi

          sleep 10
        done

        # This should never be reached due to timeout check above
        echo "status=Timeout" >> "$GITHUB_OUTPUT"
        echo "Unexpected timeout condition."
        exit 1
